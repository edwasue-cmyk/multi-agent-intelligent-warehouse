# nspect Exception: CVE-2025-64439 - LangGraph Checkpoint RCE

## Vulnerability Information
- **CVE ID**: CVE-2025-64439
- **BDSA ID**: (from nspect scan - update when available)
- **Vulnerability Source**: BDSA (Bitdefender Security Advisories) / NVD (National Vulnerability Database)
- **Severity**: Critical
- **Component**: `langgraph-checkpoint` - `JsonPlusSerializer`
- **Vulnerable Versions**: < 3.0.0 (versions 2.1.2 and below)
- **Patched Version**: 3.0.0 (minimum)
- **Vulnerability Description**: LangGraph SQLite Checkpoint is an implementation of LangGraph CheckpointSaver that uses SQLite DB (both sync and async, via aiosqlite). In versions 2.1.2 and below, the JsonPlusSerializer (used as the default serialization protocol for all checkpointing) contains a Remote Code Execution (RCE) vulnerability when deserializing payloads saved in the "json" serialization mode. By default, the serializer attempts to use "msgpack" for serialization. However, prior to version 3.0 of the checkpointer library, if illegal Unicode surrogate values caused serialization to fail, it would fall back to using the "json" mode. This issue is fixed in version 3.0.0.

## Exception Justification: NOT AFFECTED

### 1. Version Status ✅
**Installed Version**: `langgraph-checkpoint==3.0.1`

**Verification**:
```bash
$ pip show langgraph-checkpoint
Name: langgraph-checkpoint
Version: 3.0.1
```

**Conclusion**: Version 3.0.1 is **>= 3.0.0**, which includes the security fix. The vulnerability is **patched** in our installed version.

### 2. Dependency Management ✅
**Explicit Requirements in All Dependency Files**:

- `requirements.txt`: `langgraph-checkpoint>=3.0.0`
- `requirements.docker.txt`: `langgraph-checkpoint>=3.0.0`
- `pyproject.toml`: `langgraph-checkpoint>=3.0.0`
- `requirements.lock`: `langgraph-checkpoint==3.0.1`

**Blocklist Protection**:
- `requirements.blocklist.txt`: `langgraph-checkpoint<3.0.0` (blocks vulnerable versions)
- `requirements.blocklist.txt`: `langgraph-checkpoint-sqlite<3.0.0` (blocks vulnerable SQLite checkpoint package)

### 3. Architecture Defense ✅
**In-Memory State Management** (No Checkpoint Backend Used):

All LangGraph workflows use in-memory state management and do NOT use any checkpoint backend:

- `src/api/graphs/planner_graph.py`: `workflow.compile()` (no checkpointer parameter)
- `src/api/graphs/mcp_planner_graph.py`: `workflow.compile()` (no checkpointer parameter)
- `src/api/graphs/mcp_integrated_planner_graph.py`: `workflow.compile()` (no checkpointer parameter)

**Code Evidence**:
```python
# SECURITY: We intentionally use in-memory state management (no checkpointer)
# to avoid CVE-2025-8709 (SQL injection in langgraph-checkpoint-sqlite).
# If persistence is needed, use a secure checkpoint backend (e.g., Postgres).
return workflow.compile()  # No checkpointer = in-memory state
```

**Conclusion**: We do **NOT** use `JsonPlusSerializer` or any checkpoint serialization. The vulnerable component is not invoked in our codebase.

### 4. Package Status ✅
**langgraph-checkpoint-sqlite**: **NOT INSTALLED**

We do not use SQLite checkpoint backend. Verification:
```bash
$ pip list | grep langgraph-checkpoint-sqlite
(no output - package not installed)
```

### 5. Defense-in-Depth ✅
Even if checkpoint functionality was needed in the future:
- We would use `langgraph-checkpoint>=3.0.0` (patched version)
- Vulnerable versions are blocked in `requirements.blocklist.txt`
- All dependency files explicitly require secure versions

## Summary

**Status**: ✅ **NOT AFFECTED**

**Reasons**:
1. ✅ Installed version (3.0.1) is >= 3.0.0 (patched version)
2. ✅ All dependency files explicitly require `langgraph-checkpoint>=3.0.0`
3. ✅ Vulnerable versions are blocked in `requirements.blocklist.txt`
4. ✅ We use in-memory state (no checkpoint backend)
5. ✅ `JsonPlusSerializer` is not used (no checkpoint serialization)
6. ✅ `langgraph-checkpoint-sqlite` is not installed

**Risk Level**: **NONE** - The vulnerability is patched in our version, and we don't use the vulnerable component.

## References
- Full mitigation documentation: `docs/security/VULNERABILITY_MITIGATIONS.md#langgraph-checkpoint-rce-cve-2025-64439`
- CVE Details: https://nvd.nist.gov/vuln/detail/CVE-2025-64439
- GitHub Advisory: https://github.com/advisories/GHSA-wwqv-p2pp-99h5

## For Exception Tracker

### Quick Reference
**Exception Type**: Not Affected  
**BDSA/CVE**: CVE-2025-64439 (BDSA ID: [from nspect scan])  
**Component**: `langgraph-checkpoint`  
**Justification**: 
- Installed version **3.0.1** >= **3.0.0** (patched version)
- Vulnerable component (`JsonPlusSerializer`) **not used** (in-memory state only, no checkpoint backend)
- All dependency files explicitly require `langgraph-checkpoint>=3.0.0`
- Vulnerable versions (`<3.0.0`) blocked in `requirements.blocklist.txt`

**Evidence**: 
- Version verification: `pip show langgraph-checkpoint` → Version: 3.0.1
- Lock file: `requirements.lock` → `langgraph-checkpoint==3.0.1`
- Architecture: All graphs use `workflow.compile()` without checkpointer (in-memory state)
- Code references: See sections 3 and 4 above

**Documentation**: `docs/security/NSPECT_CVE-2025-64439_MITIGATION.md`

### Detailed Justification
The vulnerability affects `langgraph-checkpoint` versions < 3.0.0. Our installed version is **3.0.1**, which includes the security fix. Additionally, we do not use the vulnerable `JsonPlusSerializer` component because:
1. All LangGraph workflows use in-memory state management (no checkpoint backend)
2. No checkpointer is passed to `workflow.compile()` in any graph file
3. The vulnerable serialization code path is never executed

This is a **defense-in-depth** approach: even if checkpoint functionality was needed, we would use the patched version (3.0.1).

